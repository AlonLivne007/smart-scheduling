# Optimal Scheduling Architecture with MIP

## Executive Summary

This document outlines the architecture for implementing optimal shift scheduling using Mixed Integer Programming (MIP). The system will automatically assign employees to shifts based on constraints, preferences, and optimization objectives.

---

## Current System Analysis

### Existing Entities

- ✅ **Users** - Employees with status (ACTIVE, VACATION, SICK)
- ✅ **Roles** - Job positions (Waiter, Bartender, etc.)
- ✅ **ShiftTemplates** - Predefined shift types with timing and location
- ✅ **WeeklySchedule** - Container for a week's schedule
- ✅ **PlannedShift** - Specific shift instances in a schedule
- ✅ **ShiftAssignment** - Manual user-to-shift assignments
- ✅ **ShiftRoleRequirements** - Required roles per shift template (with counts)

### Current Limitations

- Manual assignment only (no automation)
- No preference system
- No constraint validation
- No optimization objectives
- No fairness/workload balancing

### Availability Logic

**Simplified Approach:** Employees are available by default. If they're not available:

- They request time-off (which blocks them from being assigned)
- If they're already assigned to an overlapping shift, they can't be assigned to another
- No need for explicit availability tracking - "not assigned" = available

---

## New Entities Required

### 1. **TimeOffRequest** (New Table)

**Purpose:** Track employee time-off requests (vacation, sick leave, personal days)

**Fields:**

- `request_id` (PK)
- `user_id` (FK → users)
- `start_date` (Date)
- `end_date` (Date)
- `request_type` (Enum: VACATION, SICK, PERSONAL, OTHER)
- `status` (Enum: PENDING, APPROVED, REJECTED)
- `requested_at` (DateTime)
- `approved_by_id` (FK → users, nullable)
- `approved_at` (DateTime, nullable)
- `notes` (Text, nullable)

**Use Cases:**

- Employees request time off
- Managers approve/reject requests
- MIP solver respects approved time-off

---

### 2. **EmployeePreferences** (New Table)

**Purpose:** Store employee shift preferences and constraints

**Fields:**

- `preference_id` (PK)
- `user_id` (FK → users)
- `preferred_shift_template_id` (FK → shift_templates, nullable)
- `preferred_day_of_week` (Integer, nullable)
- `preferred_start_time` (Time, nullable)
- `preferred_end_time` (Time, nullable)
- `preference_weight` (Float, default=1.0) - How important this preference is
- `effective_from` (Date)
- `effective_to` (Date, nullable)

**Use Cases:**

- Employee prefers morning shifts
- Employee prefers certain days
- Weight preferences for optimization

---

### 3. **SystemConstraints** (New Table)

**Purpose:** Define system-wide work rules that apply to all employees

**Fields:**

- `constraint_id` (PK)
- `constraint_type` (Enum: MAX_HOURS_PER_WEEK, MIN_HOURS_PER_WEEK, MAX_CONSECUTIVE_DAYS, MIN_REST_HOURS, MAX_SHIFTS_PER_WEEK, MIN_SHIFTS_PER_WEEK)
- `constraint_value` (Float/Integer) - The limit value
- `is_hard_constraint` (Boolean) - True = must be satisfied, False = soft constraint
- `effective_from` (Date) - When this constraint becomes active
- `effective_to` (Date, nullable) - When this constraint expires (null = active indefinitely)
- `notes` (Text, nullable) - Description or reason for constraint

**Use Cases:**

- Max 40 hours per week for all employees (hard)
- Prefer at least 20 hours per week for all employees (soft)
- Max 5 consecutive working days for all employees (hard)
- Minimum 11 hours rest between shifts for all employees (hard)
- Max 6 shifts per week for all employees (soft)

**Note:** These constraints apply to ALL employees. If you need different rules for different employees or weeks, you would need to adjust the constraint values or use per-week overrides (future enhancement).

---

### 4. **SchedulingRun** (New Table)

**Purpose:** Track optimization runs and results

**Fields:**

- `run_id` (PK)
- `weekly_schedule_id` (FK → shift_weekly_schedule)
- `run_type` (Enum: FULL_OPTIMIZATION, INCREMENTAL, MANUAL_OVERRIDE)
- `status` (Enum: PENDING, RUNNING, COMPLETED, FAILED, CANCELLED)
- `started_at` (DateTime)
- `completed_at` (DateTime, nullable)
- `solver_name` (String) - e.g., "CBC", "Gurobi", "CPLEX"
- `objective_value` (Float, nullable) - Final optimization score
- `solver_status` (String, nullable) - "OPTIMAL", "FEASIBLE", "INFEASIBLE", etc.
- `runtime_seconds` (Float, nullable)
- `constraints_satisfied` (Integer, nullable)
- `constraints_violated` (Integer, nullable)
- `created_by_id` (FK → users)
- `notes` (Text, nullable)

**Use Cases:**

- Track optimization history
- Compare different optimization runs
- Debug failed optimizations
- Audit trail

---

### 5. **SchedulingSolution** (New Table)

**Purpose:** Store the actual assignments generated by the optimizer

**Fields:**

- `solution_id` (PK)
- `run_id` (FK → scheduling_run)
- `planned_shift_id` (FK → planned_shifts)
- `user_id` (FK → users)
- `role_id` (FK → roles)
- `is_selected` (Boolean) - True if optimizer selected this assignment
- `assignment_score` (Float, nullable) - Contribution to objective function
- `created_at` (DateTime)

**Use Cases:**

- Store optimizer's proposed assignments
- Compare multiple solutions
- Apply solution to create actual ShiftAssignments

---

### 6. **OptimizationConfig** (New Table)

**Purpose:** Store optimization parameters and weights

**Fields:**

- `config_id` (PK)
- `config_name` (String, unique) - e.g., "default", "fairness_focused", "cost_minimization"
- `weight_fairness` (Float, default=1.0) - Weight for workload fairness
- `weight_preferences` (Float, default=1.0) - Weight for employee preferences
- `weight_cost` (Float, default=0.0) - Weight for cost minimization
- `weight_coverage` (Float, default=1.0) - Weight for shift coverage
- `max_runtime_seconds` (Integer, default=300) - Solver timeout
- `mip_gap` (Float, default=0.01) - Acceptable optimality gap (1%)
- `is_default` (Boolean, default=False)
- `created_at` (DateTime)
- `updated_at` (DateTime)

**Use Cases:**

- Different optimization strategies
- Tune optimization priorities
- A/B test different configurations

---

## MIP Model Architecture

### Decision Variables

1. **x[i,j,k]** - Binary variable
   - = 1 if employee `i` is assigned to shift `j` in role `k`
   - = 0 otherwise
   - Where:
     - `i` ∈ Employees (users with ACTIVE status)
     - `j` ∈ PlannedShifts (in the weekly schedule)
     - `k` ∈ Roles (required for shift `j`)

### Objective Function

**Minimize:** Weighted sum of penalties

```
Minimize:
  w1 * (Workload Imbalance Penalty)
+ w2 * (Preference Violation Penalty)
+ w3 * (Cost Penalty)
+ w4 * (Coverage Gap Penalty)
```

**Components:**

1. **Workload Fairness:**

   - Minimize variance in hours worked across employees
   - Penalize employees working too many/few hours

2. **Preference Satisfaction:**

   - Reward assignments matching employee preferences
   - Penalize assignments against preferences

3. **Cost Optimization (optional):**

   - Minimize total labor cost
   - Consider different pay rates per role/user

4. **Coverage:**
   - Ensure all required roles are filled
   - Penalize unfilled shifts

### Constraints

#### Hard Constraints (Must be satisfied)

1. **Role Requirements:**

   ```
   For each shift j and role k:
     Σ(i) x[i,j,k] >= required_count[j,k]
   ```

2. **Time-Off:**

   ```
   For each employee i with approved time-off on date d:
     x[i,j,k] = 0 for all shifts j on date d
   ```

3. **Role Qualifications:**

   ```
   For each employee i, shift j, role k:
     If employee i does not have role k:
       x[i,j,k] = 0
   ```

4. **No Double Assignment:**

   ```
   For each employee i, shift j:
     Σ(k) x[i,j,k] <= 1
   ```

   (Employee can only work one role per shift)

5. **No Overlapping Shifts:**

   ```
   For each employee i, overlapping shifts j1, j2:
     Σ(k) x[i,j1,k] + Σ(k) x[i,j2,k] <= 1
   ```

6. **Minimum Rest Between Shifts:**

   ```
   For each employee i, consecutive shifts j1, j2:
     If end_time[j1] + min_rest_hours (system-wide) > start_time[j2]:
       x[i,j1,k1] + x[i,j2,k2] <= 1
   ```

7. **Maximum Consecutive Days:**

   ```
   For each employee i, sequence of consecutive days:
     Σ(j in sequence, k) x[i,j,k] <= max_consecutive_days (system-wide)
   ```

8. **Maximum Hours Per Week:**

   ```
   For each employee i:
     Σ(j, k) x[i,j,k] * shift_duration[j] <= max_hours_per_week (system-wide)
   ```

9. **User Status:**
   ```
   For each employee i with status != ACTIVE:
     x[i,j,k] = 0 for all j, k
   ```

#### Soft Constraints (Penalized but not required)

1. **Minimum Hours Per Week:**

   - Add penalty if employee works less than minimum

2. **Minimum Shifts Per Week:**

   - Add penalty if employee has fewer than minimum shifts

3. **Preference Satisfaction:**

   - Penalize assignments that don't match preferences

4. **Workload Balance:**
   - Penalize high variance in hours across employees

---

## Service Layer Architecture

### 1. **SchedulingService** (New Service)

**Responsibilities:**

- Orchestrate optimization process
- Prepare data for MIP solver
- Execute optimization
- Apply solutions to database
- Validate constraints

**Key Methods:**

- `prepare_optimization_data(weekly_schedule_id)` - Extract and format data
- `build_mip_model(optimization_data, config)` - Create MIP model
- `solve_mip_model(model, config)` - Run solver
- `apply_solution(run_id, solution_id)` - Create ShiftAssignments from solution
- `validate_solution(solution)` - Check constraint satisfaction

---

### 2. **ConstraintService** (New Service)

**Responsibilities:**

- Validate employee constraints
- Check availability
- Check time-off conflicts
- Calculate workload metrics

**Key Methods:**

- `check_time_off_conflicts(user_id, date_range)` - List of conflicts
- `validate_hard_constraints(assignments)` - Validation result (uses system-wide constraints)
- `calculate_workload(user_id, weekly_schedule_id)` - Hours/shifts count
- `get_system_constraints()` - Get active system-wide constraints

---

### 3. **OptimizationDataBuilder** (New Service)

**Responsibilities:**

- Transform database entities to MIP model inputs
- Build constraint matrices
- Prepare objective function coefficients

**Key Methods:**

- `build_employee_set(weekly_schedule_id)` - List of eligible employees
- `build_shift_set(weekly_schedule_id)` - List of planned shifts
- `build_role_requirements(shift_id)` - Required roles and counts
- `build_availability_matrix()` - Employee-shift availability
- `build_preference_scores()` - Preference weights
- `build_overlap_matrix()` - Shift overlap detection

---

## API Endpoints (New)

### Optimization Endpoints

1. **POST /api/scheduling/optimize**

   - Trigger optimization for a weekly schedule
   - Body: `{ weekly_schedule_id, config_id (optional) }`
   - Returns: `SchedulingRun` object

2. **GET /api/scheduling/runs/{run_id}**

   - Get optimization run status and results
   - Returns: `SchedulingRun` with solution details

3. **POST /api/scheduling/runs/{run_id}/apply**

   - Apply a solution to create actual assignments
   - Body: `{ solution_id, overwrite_existing (boolean) }`
   - Returns: List of created `ShiftAssignment` objects

4. **GET /api/scheduling/runs/{run_id}/solutions**

   - Get all solutions for a run
   - Returns: List of `SchedulingSolution` objects

5. **POST /api/scheduling/runs/{run_id}/cancel**
   - Cancel a running optimization
   - Returns: Updated `SchedulingRun` status

---

### Employee Preferences & Constraints Endpoints

6. **GET /api/employees/{user_id}/preferences**

   - Get employee preferences
   - Returns: List of `EmployeePreferences` objects

7. **POST /api/employees/{user_id}/preferences**

   - Set/update employee preferences
   - Body: `EmployeePreferences` data

8. **GET /api/system/constraints**

   - Get system-wide constraints
   - Returns: List of `SystemConstraints` objects

9. **POST /api/system/constraints**

   - Create system-wide constraint
   - Body: `SystemConstraints` data
   - Returns: Created `SystemConstraints` object

10. **PUT /api/system/constraints/{constraint_id}**

    - Update system-wide constraint
    - Body: `SystemConstraints` data
    - Returns: Updated `SystemConstraints` object

11. **DELETE /api/system/constraints/{constraint_id}**

    - Delete system-wide constraint
    - Returns: Success message

---

### Time-Off Endpoints

12. **GET /api/time-off/requests**

    - List all time-off requests (filtered by user/status)
    - Returns: List of `TimeOffRequest` objects

13. **POST /api/time-off/requests**

    - Create time-off request
    - Body: `TimeOffRequest` data
    - Returns: Created `TimeOffRequest`

14. **PUT /api/time-off/requests/{request_id}/approve**

    - Approve time-off request (manager only)
    - Returns: Updated `TimeOffRequest`

15. **PUT /api/time-off/requests/{request_id}/reject**
    - Reject time-off request (manager only)
    - Returns: Updated `TimeOffRequest`

---

### Configuration Endpoints

16. **GET /api/optimization/configs**

    - List all optimization configurations
    - Returns: List of `OptimizationConfig` objects

17. **POST /api/optimization/configs**

    - Create optimization configuration
    - Body: `OptimizationConfig` data

18. **PUT /api/optimization/configs/{config_id}**
    - Update optimization configuration
    - Body: `OptimizationConfig` data

---

## Technology Stack

### MIP Solver Options

1. **Python-MIP** (Recommended for start)

   - Pure Python, easy integration
   - Uses CBC solver (open-source)
   - Good for small-medium problems
   - Package: `mip`

2. **PuLP** (Alternative)

   - Python library
   - Multiple solver backends
   - Package: `pulp`

3. **OR-Tools** (Google)

   - More advanced, better performance
   - Package: `ortools`

4. **Commercial Solvers** (Future)
   - Gurobi (academic licenses available)
   - CPLEX (IBM)

### Dependencies to Add

```txt
mip>=1.15.0          # MIP solver
numpy>=1.24.0        # Numerical operations
pandas>=2.0.0        # Data manipulation (optional, for analysis)
```

---

## Data Flow

### Optimization Flow

1. **User triggers optimization** via API
2. **SchedulingService** receives request
3. **OptimizationDataBuilder** extracts:
   - Employees (active, with roles)
   - Planned shifts (from weekly schedule)
   - Role requirements
   - Availability data
   - Time-off requests
   - Preferences and constraints
4. **SchedulingService** builds MIP model:
   - Creates decision variables
   - Adds hard constraints
   - Defines objective function with soft constraints
5. **MIP Solver** runs optimization
6. **SchedulingService** stores:
   - `SchedulingRun` record
   - `SchedulingSolution` records (proposed assignments)
7. **User reviews solution** via API
8. **User applies solution** → Creates `ShiftAssignment` records
9. **System updates** `PlannedShift.status` to FULLY_ASSIGNED

---

## User Stories for Jira

### Epic: Optimal Scheduling with MIP

#### Phase 1: Foundation (Data Models)

**US-1: Time-Off Request System**

- As an employee, I want to request time off so managers can approve it
- As a manager, I want to approve/reject time-off requests
- Acceptance: Employees can create requests, managers can approve/reject, system respects approved time-off
- Entities: `TimeOffRequest`

**US-2: Employee Preferences**

- As an employee, I want to set my shift preferences so the optimizer considers them
- Acceptance: Can set preferred shifts, days, times with weights
- Entities: `EmployeePreferences`

**US-3: System Constraints**

- As a manager, I want to set system-wide work rules (max hours, rest periods) so the optimizer respects them for all employees
- Acceptance: Can set hard/soft constraints that apply to all employees
- Entities: `SystemConstraints`

**US-4: Optimization Configuration**

- As a manager, I want to configure optimization weights so I can prioritize different objectives
- Acceptance: Can create/update optimization configs with different weights
- Entities: `OptimizationConfig`

---

#### Phase 2: Core Optimization Engine

**US-6: MIP Model Builder**

- As a system, I need to build MIP models from schedule data so optimization can run
- Acceptance: Can transform database entities to MIP model inputs
- Services: `OptimizationDataBuilder`, `SchedulingService`

**US-7: Constraint Validation Service**

- As a system, I need to validate constraints so I can check solution feasibility
- Acceptance: Can validate all hard constraints, detect conflicts
- Services: `ConstraintService`

**US-8: MIP Solver Integration**

- As a system, I need to solve MIP models so I can generate optimal schedules
- Acceptance: Can run Python-MIP solver, handle solver status, store results
- Services: `SchedulingService`

**US-9: Solution Storage**

- As a system, I need to store optimization solutions so users can review them
- Acceptance: Can store `SchedulingRun` and `SchedulingSolution` records
- Entities: `SchedulingRun`, `SchedulingSolution`

---

#### Phase 3: API & Integration

**US-10: Optimization API Endpoints**

- As a manager, I want to trigger optimization via API so I can generate schedules automatically
- Acceptance: POST /api/scheduling/optimize, GET /api/scheduling/runs/{id}
- Routes: New scheduling routes

**US-11: Apply Solution**

- As a manager, I want to apply an optimization solution so assignments are created
- Acceptance: POST /api/scheduling/runs/{id}/apply creates ShiftAssignments
- Routes: Scheduling routes

**US-11: Employee Preferences API**

- As an employee, I want to manage my preferences via API
- Acceptance: CRUD endpoints for preferences
- Routes: New employee management routes

**US-12: System Constraints API**

- As a manager, I want to manage system-wide constraints via API
- Acceptance: CRUD endpoints for system constraints
- Routes: /api/system/constraints

**US-13: Time-Off API**

- As an employee/manager, I want to manage time-off requests via API
- Acceptance: CRUD + approve/reject endpoints
- Routes: New time-off routes

---

#### Phase 4: Frontend Integration

**US-14: Optimization UI**

- As a manager, I want to trigger and view optimization results in the UI
- Acceptance: Button to optimize, view run status, review solutions, apply solution
- Frontend: New optimization page/component

**US-15: Employee Preferences UI**

- As an employee, I want to set my preferences in the UI
- Acceptance: Forms for availability, preferences, time-off requests
- Frontend: Employee settings page

**US-16: Time-Off Management UI**

- As a manager, I want to approve/reject time-off requests in the UI
- Acceptance: List of requests, approve/reject buttons, calendar view
- Frontend: Manager dashboard/time-off page

---

#### Phase 5: Advanced Features (Future)

**US-17: Incremental Optimization**

- As a manager, I want to optimize only unassigned shifts so I don't lose existing assignments
- Acceptance: Can optimize subset of shifts, preserve existing assignments

**US-18: Multi-Objective Optimization**

- As a manager, I want to balance multiple objectives (fairness, cost, preferences)
- Acceptance: Configurable objective weights, Pareto frontier analysis

**US-19: Optimization Analytics**

- As a manager, I want to see optimization metrics so I can improve scheduling
- Acceptance: Dashboard with fairness scores, preference satisfaction, constraint violations

**US-20: Automated Scheduling**

- As a manager, I want schedules to auto-optimize weekly so I don't have to trigger manually
- Acceptance: Scheduled job runs optimization, sends notifications

---

## Database Migration Plan

### Migration 1: Employee Preferences & System Constraints

- Create `employee_preferences` table
- Create `system_constraints` table

### Migration 2: Time-Off System

- Create `time_off_requests` table

### Migration 3: Optimization Infrastructure

- Create `optimization_configs` table
- Create `scheduling_runs` table
- Create `scheduling_solutions` table

### Migration 4: Indexes & Performance

- Add indexes on foreign keys
- Add indexes on date/time fields for queries
- Add composite indexes for common queries

---

## Testing Strategy

### Unit Tests

- Constraint validation logic
- MIP model building
- Data transformation functions

### Integration Tests

- End-to-end optimization flow
- API endpoints
- Database operations

### Performance Tests

- Solver performance with different problem sizes
- API response times
- Database query optimization

---

## Risk Mitigation

1. **Solver Performance**

   - Risk: Large problems may take too long
   - Mitigation: Set time limits, use heuristics for large problems

2. **Infeasible Solutions**

   - Risk: No solution exists for given constraints
   - Mitigation: Relax soft constraints, provide diagnostic information

3. **Data Quality**

   - Risk: Missing availability/preferences cause poor solutions
   - Mitigation: Default values, validation, user warnings

4. **Complexity**
   - Risk: Too many constraints make problem unsolvable
   - Mitigation: Prioritize constraints, allow constraint relaxation

---

## Success Metrics

1. **Optimization Success Rate:** % of runs that find feasible solutions
2. **Preference Satisfaction:** % of assignments matching preferences
3. **Workload Fairness:** Variance in hours across employees
4. **Coverage:** % of required roles filled
5. **Runtime:** Average optimization time
6. **User Satisfaction:** Manager/employee feedback

---

## Next Steps

1. ✅ Review architecture document
2. Create Jira user stories from US-1 to US-16
3. Set up development branch
4. Implement Phase 1 (Data Models)
5. Implement Phase 2 (Optimization Engine)
6. Implement Phase 3 (API)
7. Implement Phase 4 (Frontend)
8. Testing & refinement

---

## Questions to Consider

1. **Pay Rates:** Do different roles/users have different pay rates? (affects cost optimization)
2. **Skill Levels:** Are there seniority/skill levels within roles? (affects assignment quality)
3. **Shift Bidding:** Do employees bid on shifts? (affects preference system)
4. **Break Requirements:** Are there mandatory breaks during shifts? (affects shift duration)
5. **On-Call Shifts:** Are there on-call shifts? (affects availability)
6. **Multi-Location:** Do employees work at multiple locations? (affects availability/constraints)
7. **Shift Swapping:** Can employees swap shifts? (affects post-optimization changes)

---

## References

- Python-MIP Documentation: https://python-mip.readthedocs.io/
- OR-Tools Documentation: https://developers.google.com/optimization
- Shift Scheduling Literature: Nurse/Staff scheduling optimization papers
